<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EVA3 – Iniciar sesión</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="col-12 col-md-6 col-lg-4 mx-auto">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="mb-3">Iniciar sesión</h4>

          <label class="form-label">Usuario</label>
          <select id="sel-user" class="form-select"></select>

          <button id="btn-login" class="btn btn-primary w-100 mt-3">Entrar</button>

          <small class="text-muted d-block mt-3">
            Se cargan usuarios desde <code>/api/usuarios</code>. Roles: ADMIN / PROFESOR / ALUMNO.
          </small>

          <div id="alert" class="alert alert-danger mt-3 d-none"></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { setUser } from './js/session.js';

    const sel = document.getElementById('sel-user');
    const btn = document.getElementById('btn-login');
    const alertBox = document.getElementById('alert');

    // limpia sesión previa (misma clave que usa session.js)
    localStorage.removeItem('eva3User');

    async function fetchJSON(url, options={}) {
      const res = await fetch(url, { headers:{'Content-Type':'application/json'}, ...options });
      if (res.status === 204) return null;
      let data = {};
      try { data = await res.json(); } catch {}
      if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
      return data;
    }

    async function cargarUsuarios() {
      try {
        const usuarios = await fetchJSON('/api/usuarios');

        if (!Array.isArray(usuarios) || usuarios.length === 0) {
          sel.innerHTML = '<option value="">(No hay usuarios; crea desde Administración)</option>';
          btn.disabled = true;
          return;
        }

        // ordenar: ADMIN primero, luego PROFESOR, luego ALUMNO
        usuarios.sort((a,b) => {
          const rank = r => r==='ADMIN'?0 : r==='PROFESOR'?1 : 2;
          return rank(a.rol) - rank(b.rol);
        });

        sel.innerHTML = usuarios
          .map(u => `<option value="${u.id}" data-rol="${u.rol}" data-nombre="${u.nombre}">${u.nombre} — ${u.rol}</option>`)
          .join('');

        // preseleccionar primer ADMIN si existe
        const idxAdmin = usuarios.findIndex(u => u.rol === 'ADMIN');
        sel.selectedIndex = idxAdmin >= 0 ? idxAdmin : 0;

        // click login
        btn.addEventListener('click', () => {
          const opt = sel.options[sel.selectedIndex];
          if (!opt) return;

          const user = {
            id: Number(opt.value),
            nombre: opt.getAttribute('data-nombre'),
            rol: opt.getAttribute('data-rol'),
          };

          // guarda sesión con la API de session.js
          setUser(user);

          // redirección por rol
          if (user.rol === 'ADMIN') location.href = '/admin.html';
          else location.href = '/practica.html';
        });

      } catch (e) {
        alertBox.textContent = e.message || 'Error cargando usuarios';
        alertBox.classList.remove('d-none');
        btn.disabled = true;
      }
    }

    cargarUsuarios();
  </script>
</body>
</html>
