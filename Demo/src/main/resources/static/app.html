<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gestión de Proyectos - DW2</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-3">Gestión de Proyectos</h1>

  <form id="formProyecto" class="row g-3 bg-white p-3 rounded shadow-sm">
    <input type="hidden" id="id">
    <div class="col-md-4">
      <label class="form-label">Nombre</label>
      <input type="text" id="nombre" class="form-control" required>
    </div>
    <div class="col-md-8">
      <label class="form-label">Descripción</label>
      <input type="text" id="descripcion" class="form-control">
    </div>
    <div class="col-md-4">
      <label class="form-label">Fecha Inicio</label>
      <input type="date" id="fechaInicio" class="form-control">
    </div>
    <div class="col-md-4">
      <label class="form-label">Fecha Fin</label>
      <input type="date" id="fechaFin" class="form-control">
    </div>
    <div class="col-md-4">
      <label class="form-label">Estado</label>
      <select id="estado" class="form-select">
        <option value="CREADO">CREADO</option>
        <option value="EN_PROCESO">EN_PROCESO</option>
        <option value="FINALIZADO">FINALIZADO</option>
      </select>
    </div>
    <div class="col-12 d-flex gap-2">
      <button class="btn btn-primary" type="submit">Guardar</button>
      <button class="btn btn-secondary" type="button" id="btnNuevo">Nuevo</button>
    </div>
  </form>

  <div class="mt-4 bg-white p-3 rounded shadow-sm">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="m-0">Listado</h5>
      <button class="btn btn-outline-primary btn-sm" id="btnRefrescar">Refrescar</button>
    </div>
    <div class="table-responsive mt-2">
      <table class="table table-striped align-middle" id="tabla">
        <thead>
          <tr>
            <th>ID</th><th>Nombre</th><th>Estado</th><th>Inicio</th><th>Fin</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const API = '/api/proyectos';
const $ = s => document.querySelector(s);
const tbody = $('#tabla tbody');

async function cargar() {
  const res = await fetch(API);
  const data = await res.json();
  tbody.innerHTML = data.map(p => `
    <tr>
      <td>${p.id ?? ''}</td>
      <td>${p.nombre ?? ''}</td>
      <td>${p.estado ?? ''}</td>
      <td>${p.fechaInicio ?? ''}</td>
      <td>${p.fechaFin ?? ''}</td>
      <td class="d-flex gap-1">
        <button class="btn btn-sm btn-warning" onclick='editar(${JSON.stringify(p)})'>Editar</button>
        <button class="btn btn-sm btn-danger" onclick='borrar(${p.id})'>Borrar</button>
      </td>
    </tr>`).join('');
}

function editar(p){
  $('#id').value = p.id ?? '';
  $('#nombre').value = p.nombre ?? '';
  $('#descripcion').value = p.descripcion ?? '';
  $('#fechaInicio').value = p.fechaInicio ?? '';
  $('#fechaFin').value = p.fechaFin ?? '';
  $('#estado').value = p.estado ?? 'CREADO';
  window.scrollTo({top:0, behavior:'smooth'});
}

async function borrar(id){
  if(!confirm('¿Eliminar proyecto '+id+'?')) return;
  await fetch(`${API}/${id}`, { method:'DELETE' });
  await cargar();
}

$('#formProyecto').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const payload = {
    nombre: $('#nombre').value,
    descripcion: $('#descripcion').value,
    fechaInicio: $('#fechaInicio').value || null,
    fechaFin: $('#fechaFin').value || null,
    estado: $('#estado').value
  };
  const id = $('#id').value;

  const opts = {
    method: id ? 'PUT' : 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  };
  const url = id ? `${API}/${id}` : API;
  await fetch(url, opts);
  $('#formProyecto').reset();
  $('#estado').value = 'CREADO';
  $('#id').value = '';
  await cargar();
});

$('#btnNuevo').addEventListener('click', ()=>{
  $('#formProyecto').reset();
  $('#estado').value = 'CREADO';
  $('#id').value = '';
});

$('#btnRefrescar').addEventListener('click', cargar);
cargar();
</script>
</body>
</html>
